# Tenant Public Feed / Detail â€“ API Mapping & Real-API Integration

Updated: 2026-03-01

## Goal

Replace mock/legacy data sources in the new tenant public feed/detail pages with real API calls against the local DB (already imported).

Key product requirement:
- One public entry per tenant (share link) -> feed (waterfall) -> detail (secondary route).

## Why mock was used in v0

- We did import data into the DB, but **public (anonymous) read endpoints** for "tenant feed" do not exist yet.
- Existing product list/detail endpoints are **tenant-auth scoped** (`AuthGuard` + tenant selected in token), so they cannot be called from a public page safely.
- We already have a secure public access pattern via `shares` (signed query + shareToken entry), so the right integration is to extend that system to tenant-level feed.

## Existing APIs we can reuse now

### A) Share system (public entry + signed public data)

- Create share (tenant-auth required)
  - `POST /shares`
  - Payload: `{ resourceType, resourceId }`

- Public entry (no auth): shareToken -> redirect to web
  - `GET /s/:shareToken`
  - Implemented in: `apps/api/src/shares/shares.controller.ts`

- Public data fetch (no auth, but requires signature)
  - `GET /shares/:shareId/public?tenantId=...&resourceType=...&resourceId=...&exp=...&sig=...`
  - Implemented in: `apps/api/src/shares/shares.controller.ts`
  - Web currently uses this pattern for product-level share (`apps/web/app/public/share/page.tsx`).

### B) Products (tenant-auth scoped)

- List products (requires tenant-selected bearer token)
  - `GET /products`
  - Controller: `apps/api/src/products/products.controller.ts`

- Product images list
  - `GET /products/:id/images`

- Product image content
  - `GET /products/:productId/images/:imageId/content`

### C) Featured products (already supports tenantSlug query; public-ish)

- List featured products
  - `GET /products/featured?tenantSlug=...&limit=...`
  - Controller: `apps/api/src/featured-products/products-public.controller.ts`
  - Note: still enforces tenant scoping and allows anonymous read.

## What is missing (must implement)

### 1) Tenant-level share resource type

Extend share resource types to include a tenant-level feed, e.g.:
- `resourceType = 'tenant_feed'`
- `resourceId = tenantId` (or omit and derive from share)

This enables:
- One share per tenant -> one public entry.
- Public feed and public detail fetches are tenant-scoped by the share.

### 2) Public feed data response

Add a new public share payload variant that returns:
- tenant info (id/slug/name)
- feed items (products/breeders) for the tenant
- minimal fields for waterfall cards (match legacy): cover image, code/name, price badge, sex/series tags, short description

### 3) Public detail data response

Add a new public share payload variant that returns:
- one product detail (same tenant)
- image carousel data + other detail modules later (timeline/family tree etc)

## Proposed integration approach (v1)

- Keep the entry URL shape as `GET /s/:shareToken` (API redirects to web).
- Add web routes:
  - `/public/[tenantSlug]` -> feed page
  - `/public/[tenantSlug]/products/[productId]` -> detail page
- Both pages call **real API** via `GET /shares/:shareId/public` using the signed query already generated by the entry redirect.

This avoids:
- exposing tenant-auth endpoints publicly
- re-inventing auth

## Acceptance

- With local imported DB data, opening tenant public entry shows real products in waterfall.
- Clicking a card routes to detail and shows real images/fields.
- No bearer token required for public pages.
- Tenant isolation enforced server-side (share cannot read other tenant data).
