# T30/T31/T32 Admin Smoke Evidence (2026-02-28)

## Scope

- Branch: `feat/t30-32-admin-pages` (PR#6)
- Targets:
  - T30: Tenants list/search/detail
  - T31: Memberships list + upsert + `auditLogId`
  - T32: Audit logs list + filters + pagination
- Login requirement: admin session cookie (server-side), no token persisted in browser storage

## Bug Fix Included In This Smoke

- Issue found: `/admin/audit-logs` read requests were themselves written into the same audit stream and surfaced by default list, causing unstable pagination (page drift / duplicated first row across page navigation).
- Fix: default list now excludes action `admin.audit-logs.list` unless caller explicitly filters by `action`.
- File: `apps/api/src/admin/super-admin-audit-logs.service.ts`

## Minimal Repro Runbook

If services are not already running:

```bash
# Terminal A
pnpm --filter @eggturtle/api dev

# Terminal B
ADMIN_API_BASE_URL=http://localhost:30011 \
NEXT_PUBLIC_API_BASE_URL=http://localhost:30011 \
ADMIN_SUPER_EMAIL_ALLOWLIST=synthetic.superadmin@local.test \
pnpm --filter @eggturtle/admin dev
```

## Smoke Commands (curl + jq)

> Executed against `http://localhost:30020` (admin) and `http://localhost:30011` (api).

1) Login flow (`request-code` -> `verify-code` -> session cookie):

```bash
EMAIL=synthetic.superadmin@local.test
COOKIE_JAR=$(mktemp)

curl -sS -X POST http://localhost:30020/api/auth/request-code \
  -H 'content-type: application/json' \
  --data "{\"email\":\"$EMAIL\"}" | jq '{ok,expiresAt,devCode}'

DEV_CODE=<devCode from previous step>

curl -sS -D /tmp/t30-verify.headers -c "$COOKIE_JAR" \
  -X POST http://localhost:30020/api/auth/verify-code \
  -H 'content-type: application/json' \
  --data "{\"email\":\"$EMAIL\",\"code\":\"$DEV_CODE\"}" | jq '{user}'

curl -sS -b "$COOKIE_JAR" http://localhost:30020/api/auth/session | jq '{user,currentTenant}'
```

2) Tenants list/search/detail:

```bash
curl -sS -b "$COOKIE_JAR" http://localhost:30020/api/proxy/admin/tenants \
  | jq '{count:(.tenants|length),first:(.tenants[0]|{id,slug,name,memberCount})}'

TENANT_ID=<first tenant id>
TENANT_SLUG=<first tenant slug>
SEARCH_KEY=${TENANT_SLUG%%-*}

curl -sS -b "$COOKIE_JAR" "http://localhost:30020/api/proxy/admin/tenants?search=$SEARCH_KEY" \
  | jq --arg tid "$TENANT_ID" '{count:(.tenants|length),containsTenant:(any(.tenants[]?; .id==$tid))}'

curl -sS -b "$COOKIE_JAR" "http://localhost:30020/api/proxy/admin/tenants/$TENANT_ID" \
  | jq '{tenant:{id:.tenant.id,slug:.tenant.slug,name:.tenant.name,memberCount:.tenant.memberCount}}'
```

3) Memberships list + upsert + audit id:

```bash
curl -sS -b "$COOKIE_JAR" "http://localhost:30020/api/proxy/admin/tenants/$TENANT_ID/members" \
  | jq '{tenantId,count:(.members|length)}'

NEW_MEMBER_EMAIL="smoke.t31.$(date +%s)@local.test"

curl -sS -b "$COOKIE_JAR" \
  -X POST "http://localhost:30020/api/proxy/admin/tenants/$TENANT_ID/members" \
  -H 'content-type: application/json' \
  --data "{\"email\":\"$NEW_MEMBER_EMAIL\",\"role\":\"EDITOR\"}" \
  | jq '{tenantId,user:{id:.user.id,email:.user.email},role,created,previousRole,auditLogId}'
```

4) Audit logs list + filters + pagination:

```bash
ACTOR_USER_ID=$(curl -sS -b "$COOKIE_JAR" http://localhost:30020/api/auth/session | jq -r '.user.id')
FROM_ISO=$(python3 - <<'PY'
from datetime import datetime, timedelta, timezone
print((datetime.now(timezone.utc)-timedelta(days=1)).isoformat().replace('+00:00','Z'))
PY
)
TO_ISO=$(python3 - <<'PY'
from datetime import datetime, timedelta, timezone
print((datetime.now(timezone.utc)+timedelta(days=1)).isoformat().replace('+00:00','Z'))
PY
)

curl -sS -b "$COOKIE_JAR" "http://localhost:30020/api/proxy/admin/audit-logs?page=1&pageSize=5" \
  | jq '{total,page,pageSize,totalPages,sample:(.logs[0]|{id,action,actorUserId,targetTenantId})}'

curl -sS -b "$COOKIE_JAR" "http://localhost:30020/api/proxy/admin/audit-logs?tenantId=$TENANT_ID&action=admin.tenants.members.upsert&actorUserId=$ACTOR_USER_ID&from=$FROM_ISO&to=$TO_ISO&page=1&pageSize=20" \
  | jq '{total,page,pageSize,first:(.logs[0]|{id,action,actorUserId,targetTenantId,createdAt})}'

curl -sS -b "$COOKIE_JAR" "http://localhost:30020/api/proxy/admin/audit-logs?page=1&pageSize=1" | jq -r '.logs[0].id'
curl -sS -b "$COOKIE_JAR" "http://localhost:30020/api/proxy/admin/audit-logs?page=2&pageSize=1" | jq -r '.logs[0].id'
```

5) Confirm no token persisted in storage:

```bash
rg -n "localStorage|sessionStorage" apps/admin
```

## Response Snippets (Actual)

- Verify code sets HttpOnly cookie:
  - `set-cookie: eggturtle.admin.session=***; HttpOnly; SameSite=lax`
- Session endpoint after verify:

```json
{"user":{"id":"cmm4nrjbv001i5i16204okdj5","email":"synthetic.superadmin@local.test","name":null},"currentTenant":null}
```

- Membership upsert (has audit id):

```json
{"tenantId":"cmm5npraf000f5inpc6z2gwhz","user":{"id":"cmm5oofpq000a5ir9qvinzeyx","email":"smoke.t31.1772244603@local.test"},"role":"EDITOR","created":true,"previousRole":null,"auditLogId":"cmm5oofpu000e5ir935ekbh5x"}
```

- Audit filters (tenant/action/actor/from/to) matched upsert audit:

```json
{"total":3,"page":1,"pageSize":20,"containsUpsertAudit":true}
```

- Pagination after fix:
  - page1 id: `cmm5oofpu000e5ir935ekbh5x`
  - page2 id: `cmm5oofp700095ir9othpgcw6`
  - result: different (pagination stable)

- Storage scan:
  - `rg` result empty (no `localStorage` / `sessionStorage` usage in `apps/admin`)

## Pass Criteria Mapping

- T30 (tenants): PASS
  - list/search/detail all return expected shape and data.
- T31 (memberships): PASS
  - members list works; upsert writes successfully and returns `auditLogId`.
- T32 (audit logs): PASS
  - list works; filters (`tenantId/action/actorUserId/from/to`) work; pagination verified after fix.
- Admin login/session model: PASS
  - server session cookie (`HttpOnly`) used; no client token persistence.

## Self-Test

Executed from repo root:

```bash
pnpm -r lint && pnpm -r build
```

Result: PASS (no errors). Existing non-blocking warnings remain in `frontend` and `apps/web` (pre-existing lint warnings).

## Residual Risks

- This smoke validates API/proxy behavior via curl, not full browser interaction (UI rendering details still need screenshot-based acceptance).
- Audit log timestamps rely on server UTC; UI timezone rendering should be validated in final visual check.
