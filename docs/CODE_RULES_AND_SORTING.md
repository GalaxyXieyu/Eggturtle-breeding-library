# TurtleAlbum 编号规则与排序规范（草案，先评审再动工）

本文档用于统一 TurtleAlbum 的“编号(code)规则、录入方式、排序方式、溯源方式”，避免后续改来改去导致上下文污染。

> 状态：草案（需要业务确认后再落地到代码/数据库）。

## 0. 背景：为什么会出现 1、10、2 的排序

当前列表使用字符串排序（字典序）时：
- `白化-1` < `白化-10` < `白化-2`
- 这不是 bug，是排序规则与业务期望不一致。

目标：移动端瀑布流与列表显示按“数字意义”排序：`1,2,3,...,10`。

## 1. 编号体系的关键决策点（必须先定）

### 1.1 适用对象：规则是否只针对“种龟/种母/种公”

- 选项 A：编号规则仅用于“种龟（breeder）”，子代另有独立编号规则。
- 选项 B：编号规则用于所有个体（含子代）。

> 这会直接影响“溯源是否依赖编号”以及“公龟是否必须字母”的一致性。

### 1.2 溯源方式：靠编号反推母本，还是靠字段 `dam_code`

- 选项 A：溯源靠编号（例如 `白化-1-2` 反推母本 `白化-1`）。
- 选项 B：溯源靠结构化字段（`dam_code` / `sire_code`），编号只用于展示与排序。

> 当前系统已存在结构化字段 `dam_code/sire_code`，这是最稳定的溯源方式。

### 1.3 性别编码：公龟字母、母龟数字（用户当前偏好）

当前倾向：
- 公龟：字母编号（例如 `HB-G`）
- 母龟：数字编号（例如 `白化-10` / `HB-5`）

与“编号溯源”可能冲突：如果子代中存在公龟且必须字母，编号将无法通过“去掉最后一段数字”反推母本。

## 2. 推荐落地方案（满足排序 + 不增加录入负担）

### 2.1 前缀自动化

- 后台上传/编辑时，前缀不让手输，自动使用“系列名”作为前缀：
  - 选择系列 `HB` => 前缀 `HB`
  - 选择系列 `白化` => 前缀 `白化`

### 2.2 录入方式（按性别切换输入框）

- 母龟（female）：只输入数字（号数）
  - 输入：`10`
  - 生成 code：`白化-10`
- 公龟（male）：只输入字母（A-Z；输入小写自动转大写）
  - 输入：`g`
  - 生成 code：`HB-G`

### 2.3 数据库存储：新增“排序字段”，不要求补零

新增字段（`products`）：
- `code_prefix`：字符串（例如 `白化` / `HB`）
- `code_number`：整数，可空（例如 `1` / `10`）
- `code_letter`：字符串(1)，可空（例如 `A` / `G`）

说明：
- `products.code` 仍然保留完整展示编号（例如 `白化-10` / `HB-G`）。
- `code_prefix/number/letter` 仅用于排序与筛选。

### 2.4 解析规则（系统自动，不增加人工负担）

从 `products.code` 解析：
- `^<prefix>-<number>$` => `code_prefix=<prefix>`, `code_number=<number>`, `code_letter=NULL`
- `^<prefix>-<letter>$` => `code_prefix=<prefix>`, `code_letter=<letter>`, `code_number=NULL`

并在 create/update 时自动回填/校正。

### 2.5 排序规则（移动端瀑布流/列表统一）

建议排序键：
1) `code_prefix`（同系列一起）
2) `code_number` ASC NULLS LAST（母龟数字先排）
3) `code_letter` ASC NULLS LAST（公龟字母后排）
4) `code` 兜底

这样：`白化-1, 白化-2, ... 白化-10, 白化-A, 白化-B ...`。

> 若业务希望“公龟也夹在数字中间”，可调整 2/3 的优先级，但需要明确定义。

## 3. 图片/数据安全原则（必须满足）

- 不批量改动 `products.code` 来达成排序（避免触发图片路径目录问题）。
- 图片与产品关系靠 product_id 关联，不应因排序字段变更而丢失。
- 迁移/回填前：先扫描是否存在大小写冲突（例如同时存在 `HB-g` 与 `HB-G`）。

## 4. 修改步骤（实施手册）

1) 增加 DB 字段与索引
- Alembic migration：新增 `code_prefix/code_number/code_letter`（nullable）
- 加索引：`(series_id, code_prefix, code_number, code_letter)`

2) 回填脚本
- 遍历 products：根据 code 解析并回填
- 统计无法解析的 code（输出名单供人工确认）

3) 后端写入兜底
- admin create/update：自动解析并写入排序字段
- 同时保持现有“编号统一大写”策略（对字母段生效）

4) 列表接口排序调整
- 产品列表/种龟列表：改成按上述排序键排序
- 确保分页/无限滚动顺序稳定

5) 前端管理后台录入体验调整
- 选择系列 => 自动前缀
- 性别切换 => 输入框切换（母数字 / 公字母）
- 最终仍保存完整 `code`（例如 `白化-10`）

## 5. 检验步骤（验收清单）

- 数据库：
  - migration 成功
  - 回填完成且无法解析的 code 数量可接受
- 接口：
  - `GET /api/products` 与 `GET /api/breeders` 在 series 过滤下排序正确（1,2,3,...,10）
  - 翻页后仍保持正确顺序
- 前端：
  - 移动端瀑布流排序与预期一致
  - 后台录入体验：母只输数字、公只输字母，自动拼接横杠
- 图片：
  - 任意产品详情页图片仍可正常显示（抽样 20 条）

## 6. 示例（预期行为）

- 母：系列=白化，输入数字=10 => code=`白化-10`, code_prefix=白化, code_number=10
- 公：系列=HB，输入字母=g => code=`HB-G`, code_prefix=HB, code_letter=G

