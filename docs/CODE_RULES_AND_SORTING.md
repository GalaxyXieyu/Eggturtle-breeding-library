# TurtleAlbum 编号规则与排序规范（草案，先评审再动工）

本文档用于统一 TurtleAlbum 的“编号(code)规则、录入方式、排序方式、溯源方式”，避免后续改来改去导致上下文污染。

> 状态：草案（需要业务确认后再落地到代码/数据库）。

## 0. 背景：为什么会出现 1、10、2 的排序

当前列表使用字符串排序（字典序）时：
- `白化-1` < `白化-10` < `白化-2`
- 这不是 bug，是排序规则与业务期望不一致。

目标：移动端瀑布流与列表显示按“数字意义”排序：`1,2,3,...,10`。

## 1. 已确认的编号/录入口径（本次先做排序用）

> 注意：本节仅覆盖“瀑布流排序与后台录入”的口径；子代溯源编号（例如 `白化-1-1`）后续再单独讨论，不作为本次实现范围。

### 1.1 前缀来源

- 前缀不手输，**自动使用系列名**。
  - 选择系列 `HB` => 前缀 `HB`
  - 选择系列 `白化` => 前缀 `白化`

### 1.2 横杠规则

- 编号中必须使用横杠 `-` 作为分隔符（便于排序与后续扩展）。

### 1.3 性别编码（当前业务口径）

- 公龟（`sex=male`）：使用字母编号（只输入字母，系统自动大写）
  - 例：`HB-G`
- 母龟（`sex=female`）：使用数字编号（只输入数字）
  - 例：`白化-10`、`HB-5`

说明：这套规则与“子代按母系链式编号（`白化-1-1`）”存在潜在冲突，本次先不处理子代编号体系。
## 2. 落地方案（满足排序 + 不增加录入负担）

### 2.1 前缀自动化（后台）

- 后台上传/编辑时，前缀不让手输，自动使用“系列名”作为前缀。

### 2.2 录入方式（按性别切换输入框）

- 母龟：只输入数字（号数），系统拼接 `前缀-数字`
- 公龟：只输入字母（A-Z；输入小写自动转大写），系统拼接 `前缀-字母`

### 2.3 数据库存储：新增“排序字段”，不要求补零

新增字段（`products`）：
- `code_prefix`：字符串（例如 `白化` / `HB`）
- `code_number`：整数，可空（母龟编号）
- `code_letter`：字符串(1)，可空（公龟编号）

说明：
- `products.code` 仍然保留完整展示编号（例如 `白化-10` / `HB-G`）。
- `code_prefix/number/letter` 仅用于排序与筛选。
### 2.4 解析规则（系统自动，不增加人工负担）

从 `products.code` 解析：
- `^<prefix>-<number>$` => `code_prefix=<prefix>`, `code_number=<number>`, `code_letter=NULL`
- `^<prefix>-<letter>$` => `code_prefix=<prefix>`, `code_letter=<letter>`, `code_number=NULL`

并在 create/update 时自动回填/校正。

### 2.5 排序规则（移动端瀑布流/列表统一）

建议排序键：
1) `code_prefix`（同系列一起）
2) `code_number` ASC NULLS LAST（母龟数字先排）
3) `code_letter` ASC NULLS LAST（公龟字母后排）
4) `code` 兜底

这样：`白化-1, 白化-2, ... 白化-10, 白化-A, 白化-B ...`。

> 若业务希望“公龟也夹在数字中间”，可调整 2/3 的优先级，但需要明确定义。

## 3. 图片/数据安全原则（必须满足）

### 3.1 本次排序改造的安全边界

- 不批量改动 `products.code` 来达成排序（避免触发图片目录/路径问题）。
- 仅新增 `code_prefix/code_number/code_letter` 并回填，不应影响图片显示。

### 3.2 代码变更与图片路径（重要）

当前图片存储路径与 `products.code` 强关联：
- 后端上传图片会保存到磁盘目录：`static/images/<products.code>/...`
- DB 里 `product_images.url` 常见为：`images/<products.code>/<file>.jpg`

因此：
- 如果在“编辑产品”里修改了 `products.code`，理论上需要同步：
  1) 重命名磁盘目录 `static/images/<old_code>` -> `static/images/<new_code>`
  2) 批量更新该产品的 `product_images.url` 前缀
- 否则会出现“目录与编号不一致”，严重时会导致部分页面过滤图片或加载失败。

建议做法：
- 本次排序改造不改 code。
- 后续若业务确实需要改 code（例如大小写规范化、前缀规则调整），应设计一个明确的“图片路径迁移”步骤/接口，并提供回滚与冲突检测（避免误删/覆盖）。

### 3.3 迁移/回填前置检查

- 扫描是否存在大小写冲突（例如同时存在 `HB-g` 与 `HB-G`）。
- 扫描 `product_images.url` 的路径风格（`images/..` / `/static/images/..` / `static/images/..`），确保前端 `createImageUrl` 能正确展示。

## 4. 修改步骤（实施手册）

1) 增加 DB 字段与索引
- Alembic migration：新增 `code_prefix/code_number/code_letter`（nullable）
- 加索引：`(series_id, code_prefix, code_number, code_letter)`

2) 回填脚本
- 遍历 products：根据 code 解析并回填
- 统计无法解析的 code（输出名单供人工确认）

3) 后端写入兜底
- admin create/update：自动解析并写入排序字段
- 同时保持现有“编号统一大写”策略（对字母段生效）

4) 列表接口排序调整
- 产品列表/种龟列表：改成按上述排序键排序
- 确保分页/无限滚动顺序稳定

5) 前端管理后台录入体验调整
- 选择系列 => 自动前缀
- 性别切换 => 输入框切换（母数字 / 公字母）
- 最终仍保存完整 `code`（例如 `白化-10`）

## 5. 检验步骤（验收清单）

- 数据库：
  - migration 成功
  - 回填完成且无法解析的 code 数量可接受
- 接口：
  - `GET /api/products` 与 `GET /api/breeders` 在 series 过滤下排序正确（1,2,3,...,10）
  - 翻页后仍保持正确顺序
- 前端：
  - 移动端瀑布流排序与预期一致
  - 后台录入体验：母只输数字、公只输字母，自动拼接横杠
- 图片：
  - 任意产品详情页图片仍可正常显示（抽样 20 条）

## 6. 示例（预期行为）

- 母：系列=白化，输入数字=10 => code=`白化-10`, code_prefix=白化, code_number=10
- 公：系列=HB，输入字母=g => code=`HB-G`, code_prefix=HB, code_letter=G

